<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.my.gamebackend.chat.model.mapper.ChatMapper">

    <!-- 새 대화 생성 -->
    <insert id="createConversation" parameterType="ChatConversation"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_conversations (user_id, created_at, updated_at)
        VALUES (#{userId}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    </insert>

    <!-- 메시지 저장 -->
    <insert id="saveMessage" parameterType="ChatMessage">
        INSERT INTO chat_messages (conversation_id, message, is_user_message, created_at)
        VALUES (#{conversationId}, #{message}, #{isUserMessage}, CURRENT_TIMESTAMP)
    </insert>

    <!-- 대화 조회 -->
    <select id="getConversation" parameterType="long" resultType="ChatConversation">
        SELECT id, user_id, created_at, updated_at
        FROM chat_conversations
        WHERE id = #{id}
    </select>

    <!-- 대화 메시지 목록 조회 -->
    <select id="getMessages" parameterType="long" resultType="ChatMessage">
        SELECT id, conversation_id, message, is_user_message, created_at
        FROM chat_messages
        WHERE conversation_id = #{conversationId}
        ORDER BY created_at ASC
    </select>

    <!-- 사용자의 대화 목록 조회 -->
    <select id="getUserConversations" parameterType="string" resultType="ChatConversation">
        SELECT id, user_id, created_at, updated_at
        FROM chat_conversations
        WHERE user_id = #{userId}
        ORDER BY updated_at DESC
    </select>

    <!-- 대화 업데이트 -->
    <update id="updateConversation" parameterType="long">
        UPDATE chat_conversations
        SET updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>
</mapper>
